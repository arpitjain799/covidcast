---
title: 2. Compute percent change of a COVIDcast signal over time
description: Compute a sliding percent change operation on the values in a 
  `covidcast_signal` data frame, grouped by geographic location
output: 
  rmarkdown::html_vignette:
    code-copy: hover
vignette: >
  %\VignetteIndexEntry{2. Compute percent change of a COVIDcast signal over time}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = F}
options(rmarkdown.html_vignette.check_title = FALSE)
```

A simple way of assessing the growth or decay of a signal is to examine the 
percentage change in its incidence over two adjacent time windows of equal 
length. As shown here, this calculation can be done with the `pct_change()`
function.

We'll use the same reporting data here that we used in the
[**Getting started guide**](https://cmu-delphi.github.io/covidcast/modeltoolsR/articles/modeltools.html).
The code chunk below fetches the data from the 
[**Delphi API**](https://cmu-delphi.github.io/delphi-epidata/api/covidcast_signals.html).

```{r, echo = F, message = F, warning = F}
# Function for displaying table heads
library(knitr)
library(kableExtra)
table_head <- function(x, nrows = 6, title = NULL, footnote = NULL){

  kbl.out <- x %>%
    head(nrows) %>%
    kbl(format = "html", digits = 3) %>%
    kable_styling(bootstrap_options = c("striped","hover","condensed","responsive"))
  
  if ( !is.null(title) ){
    header <- ncol(x)
    names(header) <- title
    kbl.out <- kbl.out %>% add_header_above(header, font_size = 15, line = F)
  }
  if ( !is.null(footnote) ){
    kbl.out <- kbl.out %>% add_footnote(footnote, notation = "symbol")
  }
  if ( nrows > 20 ){
    kbl.out <- kbl.out %>% 
      scroll_box(width = "100%", height = "300px", box_css = "border: 0px solid #fff; padding: 2px; ")
  }
  return(kbl.out)
}
```

```{r message = F}
library(covidcast)
library(dplyr)

start_day <- "2020-06-01"
end_day <- "2020-11-15"
geo_values <- c("ca","fl","ny","tx")

case_rates <- covidcast_signal(data_source = "usa-facts",
                               signal = "confirmed_7dav_incidence_prop",
                               start_day = start_day, 
                               end_day = end_day,
                               geo_type = "state", 
                               geo_values = geo_values) %>%
  select(data_source, signal, geo_value, time_value, value) 

case_rates %>% 
  table_head(title = "Daily COVID-19 cases per 100,000 pop. (7-day trailing average)")
```

The `table_head` function used above is an internal function that we use in 
these tutorial vignettes to display table heads. The source code can be found
in the [`vignettes/pct-change.Rmd`](pct-change.Rmd) file used to build this
page.


## Percentage change

### Definition

For any fixed date with a trailing window of `n` days, where 
$n\in\{2,4,6,\dots\}$, we define the $n/2$-day percentage change of a signal as 
$$\frac{B - A}{A}\cdot 100\%,$$ where

* $A$ is the total incidence of the signal over the first $n/2$ days of the 
trailing window,

* $B$ is the total incidence of the signal over the last $n/2$ days of the 
trailing window.

The `pct_change()` function exploits the functionality of `slide_by_geo()`
to slide this trailings calculation over a
[`covidcast_signal`](../../../docs/covidcastR/reference/covidcast_signal.html)
data frame.

The default setting is `n = 14`, corresponding to the percentage change in a
signal over back-to-back weeks. We refer to this here as 
**weekly percentage change**. Similarly, we'll use **daily percentage change**
to refer to the `n = 2` case.


### Function call 

The percentage change calculation follows via the following one-line call to
`pct_change()`:

```{r, message = F, warning = F}
library(modeltools)
case_rates <- pct_change(case_rates, n = 14, col_name = "pct_change")
case_rates %>% 
  table_head(title = "Daily COVID-19 cases per 100,000 pop. (7-day trailing average)", n = 25)
```

We do not allow missing values in the percentage change calculation, so as we
see above, the `weekly_pct_change` is `NA` until `n = 14` days of data are 
available.


### Visualizing the results

Below we plot the weekly percentage change of the smoothed COVID-19 case rates 
fetched above alongside the smoothed COVID-19 case rates themselves. Here, we 
focus solely on Florida COVID-19 case rates. 

```{r, message = F, warning = F, fig.width = 8, fig.height = 4}
library(ggplot2)
library(gridExtra)

state <- "fl"

p1 <- ggplot(case_rates %>% filter(geo_value == state), aes(x = time_value, y = value)) +
  geom_line() +
  labs(title = "Florida COVID-19 case rates (smoothed)",
       x = "Date", y = "Cases per 100,000 people")

p2 <- ggplot(case_rates %>% filter(geo_value == state), aes(x = time_value, y = pct_change)) +
  geom_line() +
  labs(title = "Weekly percentage change", x = "Date", y = "Weekly percentage change")

grid.arrange(p1, p2, nrow = 1)
```


## Post-hoc smoothing a percentage change time series

For smaller choices of `n`, the $n/2$-day percentage change of a `covidcast`
signal can become increasingly volatile. In these cases, post-processing the 
signal's percentage change times series with a smoother may provide a times 
series that better reflects the true temporal dynamics of the `covidcast` signal
at the `n`-day scale.

Here, first we compute the 1-day percentage change (which we will also call
**daily percentage change**) time series of the state-level COVID-19 case rates
examined above, and then we post-process each state's percentage change time 
series with a 7-day trailing average via a suitable application of 
`slide_by_geo()`.

```{r, message = F, warning = F}
case_rates <- case_rates %>%
  pct_change(n = 2, col_name = "pct_change_daily") %>%
  slide_by_geo(~ Mean(.x$pct_change_daily), n = 7, col_name = "pct_change_daily_7dav")
```

<div class="fold o">
```{r, message = F, warning = F, echo = F}
case_rates %>%
  arrange(geo_value) %>% 
  select(geo_value, time_value, value, pct_change_daily, pct_change_daily_7dav) %>%
    table_head(title = "U.S. COVID-19 case rates (with daily % change and post-hoc trailing average)")
```
</div>


### Visualizing the results

Here we show again the COVID-19 case rates in Florida, but now next to its daily
percentage change time series 
(<span style="color: red;">shown in red</span>). As expected, a direct 
calculation of the percentage change in COVID-19 case rates at the daily level 
yields a highly volatile time series that is almost surely not representative of 
real variations in the spread of COVID-19 in Florida. The daily percentage 
change post-processed with a 7-day trailing average 
(<span style="color: blue;">shown in blue</span>) is likely a better indicator.

```{r, message = F, warning = F, fig.width = 8, fig.height = 4.5}
library(tidyr)

p1 <- ggplot(case_rates %>% filter(geo_value == state), aes(x = time_value, y = value)) +
  geom_line() + 
  labs(title = "Florida COVID-19 case rates (smoothed)", x = "Date", y = "Cases per 100,000 people") + 
  theme(plot.margin = margin(l = 0.1, t = 0.2, b = 1.6, unit = "cm"))

case_rates <- case_rates %>%
  select(-pct_change) %>%
  pivot_longer(cols = starts_with("pct"), names_to = "pct_change", values_to = "pct_change_val")

p2 <- ggplot(case_rates %>% filter(geo_value == state), aes(x = time_value)) +
  geom_line(aes(y = pct_change_val, color = pct_change)) + 
  scale_color_manual(values = c('red', 'blue')) +
  labs(x = "Date", y = "Daily percent change", title = "Daily percent change") +
  theme(legend.position = "bottom", legend.title = element_blank())

grid.arrange(p1, p2, nrow = 1)
```
