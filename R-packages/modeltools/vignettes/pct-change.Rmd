---
title: 1. Computing percentage change of a covidcast signal over time
description: Computing the percentage change of covidcast signal values over 
  time.
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{1. Computing percentage change of a covidcast signal over time}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = FALSE}
options(rmarkdown.html_vignette.check_title = FALSE)
```

A simple way of assessing the growth and decay of a `covidcast` signal is to 
look at the percentage change in its cumulative value between two adjacent time 
windows of equal length. We illustrate this in the current vignette using the 
`pct_change()` function from the `modeltools` package. 


## Downloading data from Delphi's Epidata API

As in the 
[**_Getting started_**](https://cmu-delphi.github.io/covidcast/modeltoolsR/articles/modeltools.html)
guide, we focus on state-level COVID-19 case rates from the 
[**USAFacts**](https://cmu-delphi.github.io/delphi-epidata/api/covidcast-signals/usa-facts.html) 
data source, smoothed with 7-day trailing averages, from June 1, 2020 to 
November 15, 2020. The code chunk below fetches these data from the 
[**Delphi API**](https://cmu-delphi.github.io/delphi-epidata/api/covidcast_signals.html).

```{r message = FALSE}
library(covidcast)
library(dplyr)

start_day <- "2020-06-01"
end_day <- "2020-11-15"
geo_values <- c("ca", "fl", "ny", "tx")

case_rates <- covidcast_signal(data_source = "usa-facts",
                               signal = "confirmed_7dav_incidence_prop",
                               start_day = start_day, 
                               end_day = end_day,
                               geo_type = "state", 
                               geo_values = geo_values)
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
# Function for displaying nice html table heads
library(knitr)
library(kableExtra)
table_head <- function(x, nrows = 6, title = NULL, footnote = NULL){

  kbl.out <- x %>%
    head(nrows) %>%
    kbl(format = "html", digits = 3) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
  
  if ( !is.null(title) ){
    header <- ncol(x)
    names(header) <- title
    kbl.out <- kbl.out %>% add_header_above(header, font_size = 15, line = F)
  }
  if ( !is.null(footnote) ){
    kbl.out <- kbl.out %>% add_footnote(footnote, notation = "symbol")
  }
  if ( nrows > 20 ){
    kbl.out <- kbl.out %>% 
      scroll_box(width = "100%", height = "300px", box_css = "border: 0px solid #fff; padding: 2px; ")
  }
  return(kbl.out)
}
```

```{r echo = FALSE}
case_rates %>%
  select(data_source, signal, geo_value, time_value, value) %>% 
  table_head(title = "Daily COVID-19 cases per 100,000 (7-day trailing average)")
```

The `table_head` function used above is a custom function for displaying nice 
table heads in HTML. See the [`vignettes/pct-change.Rmd`](pct-change.Rmd) 
file used to build this page to see the function's source code.


## Percentage change

The `pct_change()` function operates on a `covidcast_signal` data frame by 
taking a *positive, even integer* argument `n` that specifies the length of a 
trailing time window (in days), calculating a *sliding* percentage change in the
reported signal values, and then returning the original `covidcast_signal` data 
frame with a new column appended that contains the calculated percentage change 
of the `covidcast` signal for each `geo_value`-`time_value` pair in the data
frame.


### Definition

Given a trailing window of length `n`, where $n\in\{2,4,6,\dots\}$, we define
the $n/2$-day percentage change of a `covidcast` signal on a given date as
$$\frac{B - A}{A}\cdot 100\%,$$ where

* $A$ is the sum of the `covidcast` signal values over the first $n/2$ days of the 
trailing window,

* $B$ is the sum of the `covidcast` signal values over the last $n/2$ days of the 
trailing window.

The default trailing window length is `n = 14`, which corresponds to the 
percentage change of a `covidcast` signal over back-to-back weeks. We may refer
to this as *7-day percentage change* or *weekly percentage change*.


### Function call 

The percentage change (here, weekly) calculation follows via the following 
one-line call to `pct_change()`:

```{r, message = FALSE, warning = FALSE}
library(modeltools)
case_rates <- pct_change(case_rates, n = 14)
```


Now inspecting the output data frame:

```{r, message = FALSE, echo = FALSE}
case_rates %>% 
  arrange(geo_value) %>% 
  select(geo_value, time_value, value, pct_change) %>%
  head(30) %>%
  kbl(format = "html", digits = 3, booktabs = TRUE, centering = TRUE) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  add_header_above(c("U.S. COVID-19 case rates (with weekly percentage change)" = 4), align = "c", font_size = "large", line = F) %>% 
  scroll_box(width = "100%", height = "300px", box_css = "border: 0px solid #fff; padding: 2px; ")
```

We do not allow missing values in the percentage change calculation, so as we
see above, for each `geo_value`, the calculated `pct_change` is `NA` whenever
`n` trailing days of the signal are not available.


### Visualizing the results

Below we plot the weekly percentage change of the smoothed COVID-19 case rates 
fetched above alongside the smoothed COVID-19 case rates themselves. Here, we 
focus solely on Florida COVID-19 case rates. 

```{r, message = F, warning = F, fig.align = "center", fig.width = 8, fig.height = 4, fig.retina = 2, dpi = 85}
library(ggplot2)
library(gridExtra)

state <- "fl"

p1 <- ggplot(case_rates %>% filter(geo_value == state), aes(x = time_value, y = value)) +
  geom_line() +
  labs(title = "Florida COVID-19 case rates (smoothed)",
       x = "Date", y = "Cases per 100,000 people")

p2 <- ggplot(case_rates %>% filter(geo_value == state), aes(x = time_value, y = pct_change)) +
  geom_line() +
  labs(title = "Weekly percentage change", x = "Date", y = "Weekly percentage change")

grid.arrange(p1, p2, nrow = 1)
```


## Post-hoc smoothing a percentage change time series

For smaller choices of `n`, the $n/2$-day percentage change of a `covidcast`
signal can become increasingly volatile. In these cases, post-processing the 
signal's percentage change times series with a smoother may provide a times 
series that better reflects the true temporal dynamics of the `covidcast` signal
at the `n`-day scale.

Here, first we compute the 1-day percentage change (which we will also call
*daily percentage change*) time series of the state-level COVID-19 case rates
examined above, and then we post-process each state's percentage change time 
series with a 7-day trailing average via a suitable application of 
`slide_by_geo()`.

```{r, message = FALSE, warning = FALSE}
case_rates <- case_rates %>%
  pct_change(n = 2, col_name = "pct_change_daily") %>%
  slide_by_geo(~ Mean(.x$pct_change_daily), n = 7, col_name = "pct_change_daily_7dav")
```

```{r, message = FALSE, warning = FALSE, echo = FALSE}
case_rates %>%
  arrange(geo_value) %>% 
  select(geo_value, time_value, value, pct_change_daily, pct_change_daily_7dav) %>%
  head(n = 25) %>%
  kbl(format = "html", digits = 3, booktabs = TRUE, centering = TRUE) %>% 
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  add_header_above(c("U.S. COVID-19 case rates (with daily % change and post-hoc trailing average)" = 5), align = "c", font_size = "large", line = F) %>% 
  scroll_box(width = "100%", height = "300px", box_css = "border: 0px solid #fff; padding: 2px; ")
```



### Visualizing the results

Here we show again the COVID-19 case rates in Florida, but now next to its daily
percentage change time series 
(<span style="color: red;">shown in red</span>). As expected, a direct 
calculation of the percentage change in COVID-19 case rates at the daily level 
yields a highly volatile time series that is almost surely not representative of 
real variations in the spread of COVID-19 in Florida. The daily percentage 
change post-processed with a 7-day trailing average 
(<span style="color: blue;">shown in blue</span>) is likely a better indicator.

```{r, message = F, warning = F, fig.align = "center", fig.width = 8, fig.height = 4.5, fig.retina = 2, dpi = 85}
library(tidyr)

p1 <- ggplot(case_rates %>% filter(geo_value == state), aes(x = time_value, y = value)) +
  geom_line() + 
  labs(title = "Florida COVID-19 case rates (smoothed)", 
       x = "Date", y = "Cases per 100,000 people") + 
  theme(plot.margin = margin(l = 0.1, t = 0.2, b = 1.6, unit = "cm"))

case_rates <- case_rates %>%
  select(-pct_change) %>%
  pivot_longer(cols = starts_with("pct"), names_to = "pct_change", values_to = "pct_change_val")

p2 <- ggplot(case_rates %>% filter(geo_value == state), aes(x = time_value)) +
  geom_line(aes(y = pct_change_val, color = pct_change)) + 
  scale_color_manual(values=c('red', 'blue')) +
  labs(x = "Date", y = "Daily percentage change", title = "Daily percentage change") +
  theme(legend.position = "bottom", legend.title = element_blank())

grid.arrange(p1, p2, nrow = 1)
```
