---
title: 1. Compute trailing window operations on a COVIDcast signal
description: Compute trailing window operations on the values in a 
  `covidcast_signal` data frame, grouped by geographic location
output: 
  rmarkdown::html_vignette:
    code-copy: hover
vignette: >
  %\VignetteIndexEntry{1. Compute trailing window operations on a COVIDcast signal}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = F}
options(rmarkdown.html_vignette.check_title = FALSE)
```

```{css, echo = F}
details summary {
  font-family: 'JetBrains Mono', monospace;
  font-size: 7pt;
  display: flex;
  justify-content: center;
  text-align: center;
  border-radius: 10px 10px 10px 10px;
  padding: 1px 5px 1px 5px;
  width: 14%;
  margin: 0 0 15px 0;
  background-color: #A6CEE3;
  border-style: ridge;
  border-color: #A6CEE3;
  box-shadow: 3px 3px 4px black;
  cursor: pointer;
  list-style: none;
}
```

## Sliding

One of the most fundamental tools in the `modeltools` package is the 
`slide_by_geo()` function, which is based on the family of functions provided by
the 
[`slider`](https://cran.r-project.org/web/packages/slider/vignettes/slider.html)
package. The `slide_by_geo()` function allows a user to compute arbitrary trailing
window operations on the values in a `covidcast_signal()` data frame by passing
either a function or formula to the `slide_fun` argument. Many other
functions in `modeltools`, such as `pct_change()` and `estimate_deriv()`, use 
`slide_by_geo()` as their workhorse. 

We'll use the same USAFacts reporting data in our examples here that we used in
the
[**Getting started guide**](https://cmu-delphi.github.io/covidcast/modeltoolsR/articles/modeltools.html).
The code chunk below fetches the data from the 
[**Delphi API**](https://cmu-delphi.github.io/delphi-epidata/api/covidcast_signals.html).

```{r, message = F, warning = F}
library(covidcast)
library(dplyr)

source <- "usa-facts"
start_day <- "2020-03-01"
end_day <- Sys.Date() - 5
geo_values <- c("ca","fl","ny","pa")

case_rates <- covidcast_signals(data_source = source,
                               signal = c("confirmed_incidence_prop",
                                          "confirmed_7dav_incidence_prop"),
                               start_day = start_day,
                               end_day = end_day,
                               geo_type = "state",
                               geo_values = geo_values) %>%
  aggregate_signals(format = "wide") %>%
  setNames(gsub(paste0("value\\+0:", source, "_"), "", names(.))) %>%
  arrange(desc(geo_value), desc(time_value))
```

```{r, chunk-1, message = F, warning = F, echo = F}
knitr::kable(head(case_rates)) %>% 
  kableExtra::add_header_above(c("Daily COVID-19 cases per 100,000 pop." = 4))
```


### Sliding with a function 

When a function is passed to the `slide_fun` argument of `slide_by_geo()`,
it must follow the following input argument structure: 

1. `x` : a data frame with the same column names as the data frame passed to
`slide_by_geo()`

2. Any number of additional **named** arguments

3. An ellipsis `...` to allow for any number of additional general arguments

#### Example 1: Computing a 7-day trailing average by sliding a function

In this example we reproduce the 7-day trailing average calculation that the 
Delphi API performs on the case rates signal studied here, as well as many 
others. This can be done by passing the 
[`covidcast_signal`](https://cmu-delphi.github.io/covidcast/covidcastR/reference/covidcast_signal.html) 
data frame fetched above to `slide_by_geo()`, letting `n = 7`, and then passing
an averaging function to the `slide_fun` argument, as follows:

```{r}
library(modeltools)
case_rates <- slide_by_geo(case_rates, slide_fun = function(x, ...) mean(x$confirmed_incidence_prop), 
                           n = 7, col_name = "slide_by_geo_7dav") 
```

```{r, echo = F}
case_rates %>% 
  arrange(desc(geo_value), desc(time_value)) %>% 
  head() %>%
  knitr::kable() %>% 
  kableExtra::add_header_above(c("Daily COVID-19 cases per 100,000 population" = 5))
```

Notice that the above `slide_by_geo()` call returns a data frame with a new 
column appended that contains the results of the sliding operation specified by
`slide_fun`. By default, this column is named `"slide_value"`, but alternate
names can be passed to `slide_by_geo()`. Here, we've named the new column
`"slide_by_geo_7dav"`.

Since this example is meant to reproduce the 7-day trailing average calculation 
carried out by the Delphi API, the values in the `"slide_by_geo_7dav"` column 
should match the pre-computed smoothed daily case rates signal stored in the API 
(to machine precision). To check this, the code chunk below calculates the 
maximum absolute difference between the two 7-day trailing averages, 
over all state-date pairs.

```{r, collapse = T}
case_rates %>%
  mutate(difference = `slide_by_geo_7dav` - confirmed_7dav_incidence_prop) %>%
  filter(time_value >= "2020-03-07") %>%
  summarize(max(abs(difference))) %>%
  as.numeric
```

The trivial output confirms that the two columns match to machine precision.

**Note:**
The raw daily case rates that we pass to `slide_by_geo()` begin on March 1, 2020,
so the `"trailing_7dav"` column created by `slide_by_geo()` doesn't represent a true 
*7-day average* until March 7, 2020. This is why we only perform the sanity check
calculation above on the dates March, 2020, ..., `Sys.date() - 5`. When a 
trailing window of `n` days is not available, `slide_by_geo()` just applies the
`slide_fun` function/formula to whatever data *is* available. So for March `n`th,
`n = 1,...,6`, the values in the `"trailing_7dav"` column are only `n`-day trailing
averages. 


### Sliding with a formula

#### Example 2: Computing a 7-day trailing average by sliding a formula

The code chunk below reproduces the 7-day trailing average calculation from
[**Example 1**][Example 1: Computing a 7-day trailing average by sliding a function], 
but passes a function to the `slide_fun` argument instead of a formula.
Note that the formula passed to `slide_fun` has access to all columns present 
in the original
[`covidcast_signal`](https://cmu-delphi.github.io/covidcast/covidcastR/reference/covidcast_signal.html) 
data frame, and must be referred to with the prefix `.x$`. 

```{r, message = FALSE, warning = FALSE}
case_rates <- slide_by_geo(case_rates, slide_fun = ~ mean(.x$confirmed_incidence_prop),
                           n = 7, col_name = "slide_by_geo_7dav")
```

```{r, echo = F}
case_rates %>% 
  arrange(desc(geo_value), desc(time_value)) %>% 
  head() %>%
  knitr::kable() %>% 
  kableExtra::add_header_above(c("Daily COVID-19 cases per 100,000 pop." = 5))
```
