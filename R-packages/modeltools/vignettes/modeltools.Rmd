---
title: Get started with modeltools
description: An introductory tutorial with examples.
output: 
  rmarkdown::html_vignette:
    code-copy: hover
vignette: >
  %\VignetteIndexEntry{Get started with modeltools}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{css, echo = F}
details summary {
  font-family: 'JetBrains Mono', monospace;
  font-size: 7pt;
  display: flex;
  justify-content: center;
  text-align: center;
  border-radius: 10px 10px 10px 10px;
  padding: 1px 5px 1px 5px;
  width: 14%;
  margin: 0 0 15px 0;
  background-color: #A6CEE3;
  border-style: ridge;
  border-color: #A6CEE3;
  box-shadow: 3px 3px 4px black;
  cursor: pointer;
  list-style: none;
}
```

## Installation

<span style="color:#ff3333;"><font size="3"><b>
This package is not on CRAN!
</b></font></span>

The CRAN `modeltools` package is entirely unrelated to this one. Delphi's 
`modeltools` package can be installed from our 
[**GitHub page**](https://github.com/cmu-delphi/covidcast/tree/main/R-packages/modeltools)
with the following command:

```{r, eval = F}
devtools::install_github(repo = "cmu-delphi/covidcast", subdir = "R-packages/modeltools", 
                         ref = "modeltools")
```


## Downloading COVIDcast signals

In this **Getting started** vignette, we'll fetch daily COVID-19 case rate 
reporting data (i.e. the number of new COVID-19 cases reported per day, per 
100,000 population) from Delphi's
[**COVIDcast Epidata API**](https://cmu-delphi.github.io/delphi-epidata/api/covidcast_signals.html).
The cases rates we'll examine here are reported by [**USAFacts**](https://usafacts.org/)
and cloned into Delphi's API every day. As with many other signals, the API also
stores a smoothed version of the signal --- a 7-day trailing average of the
(raw) daily case rates reported by USAFacts. Here, we'll look at both the raw
and smoothed USAFacts case rates from June 1, 2020 through November 15, 2020 for
four U.S. states --- CA, FL, NY, and PA.

```{r, message = F, warning = F}
library(covidcast)
library(dplyr)

start_day <- "2020-03-01"
end_day <- Sys.Date() - 5
geo_values <- c("ca","fl","ny","pa")

case_rates <- covidcast_signals(data_source = "usa-facts",
                               signal = c("confirmed_incidence_prop",
                                          "confirmed_7dav_incidence_prop"),
                               start_day = start_day,
                               end_day = end_day,
                               geo_type = "state",
                               geo_values = geo_values) %>%
  aggregate_signals(format = "wide") %>%
  setNames(gsub("value\\+0:usa-facts_","",names(.))) %>%
  arrange(geo_value, time_value)
```


```{r, chunk-1, message = F, warning = F, echo = F, class = "table foo"}
library(reactable)
library(crosstalk)

case_rates_data <- SharedData$new(case_rates, group = "geo_value")
col3.header <- JS("function(colInfo) {return colInfo.column.name + '<div style=\"color: #999\">Cases per 100,000</div>'}")
col4.header <- JS("function(colInfo) {return colInfo.column.name + '<div style=\"color: #999\">Cases per 100,000 (smoothed)</div>'}")
col2.def <- colDef(html = T, format = colFormat(date = T), sortable = T, 
                   align = "right", maxWidth = 100)
col3.def <- colDef(minWidth = 170, html = T, format = colFormat(digits = 3), 
                   sortable = T, align = "center", header = col3.header)
col4.def <- colDef(minWidth = 200, html = T, format = colFormat(digits = 3), 
                   sortable = T, align = "center", header = col4.header )

columns <- list(geo_value = colDef(html = T, align = "left", maxWidth = 90),
                time_value = col2.def, confirmed_incidence_prop = col3.def,
                confirmed_7dav_incidence_prop = col4.def)

case_rates_tbl <- reactable(case_rates_data, sortable = F, showSortable = T, 
                            striped = T, defaultPageSize = 10, paginationType = "jump",
                            columns = columns)

bscols(case_rates_tbl, list(filter_checkbox("geo_value", "State", case_rates_data, ~toupper(geo_value))),
       widths = c(10,2), device = "lg")
```
<details><summary>**Show Source Code**</summary>
```{r, chunk-1, eval = F}
```
</details>
<br>

Below we plot the weekly percentage change of the smoothed COVID-19 case rates 
fetched above alongside the smoothed COVID-19 case rates themselves. Here, we 
focus solely on Florida COVID-19 case rates. 

```{r, chunk-2, message = F, warning = F, fig.width = 8, fig.height = 8, fig.asp = 1, echo = F}
library(tidyr)
library(ggplot2)
library(ggpubr)

case_rates <- case_rates %>% pivot_longer(3:4)
max.y <- case_rates %>%
  filter(name == "confirmed_7dav_incidence_prop") %>%
  pull(value) %>%
  max

CA <- ggplot(case_rates %>% filter(geo_value == "ca"), aes(x = time_value)) +
  scale_color_manual(labels = c("Daily cases per 100,000 population", 
                                "Daily cases per 100,000 population (7-day trailing average)"),
                     values = c("#A6CEE3", "#1F78B4")) +
  ylim(0, max.y) +
  geom_line(aes(y = value, col = rev(name)), size = 0.6) +  
  theme(legend.position = "none", legend.title = element_blank(), legend.text = element_text(size = 11)) +
  labs(x = "Date", y = "Daily cases per 100,000 population", title = "COVID-19 case rates in California") 

FL <- ggplot(case_rates %>% filter(geo_value == "fl"), aes(x = time_value)) +
  scale_colour_brewer(type = "qual", palette = 3) + 
  ylim(0, max.y) +
  geom_line(aes(y = value, col = rev(name)), size = 0.6) +  
  labs(x = "Date", y = "Daily cases per 100,000 population", title = "COVID-19 case rates in Florida")

NY <- ggplot(case_rates %>% filter(geo_value == "ny"), aes(x = time_value)) +
  scale_colour_brewer(type = "qual", palette = 3) + 
  ylim(0, max.y) +
  geom_line(aes(y = value, col = rev(name)), size = 0.6) +  
  labs(x = "Date", y = "Daily cases per 100,000 population", title = "COVID-19 case rates in New York")

TX <- ggplot(case_rates %>% filter(geo_value == "pa"), aes(x = time_value)) +
  scale_colour_brewer(type = "qual", palette = 3) + 
  ylim(0, max.y) +
  geom_line(aes(y = value, col = rev(name)), size = 0.6) +  
  labs(x = "Date", y = "Daily cases per 100,000 population", title = "COVID-19 case rates in Pennsylvania")

ggarrange(CA, FL, NY, TX, nrow = 2, ncol = 2, common.legend = T, legend = "bottom", align = "hv")
```
<details><summary>**Show Source Code**</summary>
```{r, chunk-2, eval = F}
```
</details>
<br>
